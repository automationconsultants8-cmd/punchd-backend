// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                    String   @id @default(uuid())
  name                  String
  address               String?
  city                  String?
  state                 String?
  zip                   String?
  inviteCode            String   @unique @default(uuid())
  defaultHourlyRate     Decimal? @db.Decimal(10, 2)
  subscriptionTier      String   @default("basic")
  subscriptionStatus    String   @default("active")
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  trialEndsAt           DateTime?
  settings              Json     @default("{}")
  overtimeSettings      Json     @default("{\"dailyOtThreshold\": 480, \"dailyDtThreshold\": 720, \"weeklyOtThreshold\": 2400, \"otMultiplier\": 1.5, \"dtMultiplier\": 2.0}")
  breakComplianceSettings Json   @default("{\"enabled\": true, \"state\": \"CA\", \"mealBreakThreshold\": 300, \"mealBreakDuration\": 30, \"secondMealThreshold\": 600, \"restBreakInterval\": 240, \"restBreakDuration\": 10, \"penaltyRate\": 1.0}")
  
  payPeriodType         String?
  payPeriodStartDay     Int?      @default(1)
  payPeriodAnchorDate   DateTime?
  customPayPeriodDays   Int?
  
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  users                 User[]
  jobs                  Job[]
  timeEntries           TimeEntry[]
  violations            Violation[]
  faceVerificationLogs  FaceVerificationLog[]
  shifts                Shift[]
  shiftTemplates        ShiftTemplate[]
  auditLogs             AuditLog[]
  workerJobRates        WorkerJobRate[]
  breakViolations       BreakViolation[]
  certifiedPayrolls     CertifiedPayroll[]
  shiftRequests         ShiftRequest[]
  timeOffRequests       TimeOffRequest[]
  messages              Message[]
  managerPermissions    ManagerPermission[]
  managerLocationAssignments ManagerLocationAssignment[]
  managerWorkerAssignments   ManagerWorkerAssignment[]
  payPeriods            PayPeriod[]
  leavePolicies         LeavePolicy[]
  leaveBalances         LeaveBalance[]
  timesheets            Timesheet[]

  @@map("companies")
}

enum WorkerType {
  HOURLY
  SALARIED
  CONTRACTOR
  VOLUNTEER
}

enum UserRole {
  WORKER
  MANAGER
  ADMIN
  OWNER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ShiftAssignmentStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model User {
  id                  String         @id @default(uuid())
  companyId           String
  email               String?
  phone               String
  name                String
  role                UserRole       @default(WORKER)
  workerTypes         WorkerType[]   @default([HOURLY])
  referencePhotoUrl   String?
  rekognitionFaceId   String?
  isActive            Boolean        @default(true)
  approvalStatus      ApprovalStatus @default(APPROVED)
  passwordHash        String?
  hourlyRate          Decimal?       @db.Decimal(10, 2)
  
  address             String?
  city                String?
  state               String?
  zip                 String?
  lastFourSSN         String?
  tradeClassification String?
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries         TimeEntry[]
  violations          Violation[]
  faceVerificationLogs FaceVerificationLog[]
  shifts              Shift[]
  passwordResetTokens PasswordResetToken[]
  approvedTimeEntries TimeEntry[] @relation("ApprovedTimeEntries")
  jobRates            WorkerJobRate[]
  breakViolations     BreakViolation[]
  
  shiftRequestsCreated    ShiftRequest[] @relation("ShiftRequestRequester")
  shiftRequestsAsTarget   ShiftRequest[] @relation("ShiftRequestSwapTarget")
  shiftRequestsReviewed   ShiftRequest[] @relation("ShiftRequestReviewer")
  shiftOffersReceived     ShiftOffer[]   @relation("ShiftOffersReceived")
  
  timeOffRequestsCreated  TimeOffRequest[] @relation("TimeOffRequester")
  timeOffRequestsReviewed TimeOffRequest[] @relation("TimeOffReviewer")
  
  messagesSent            Message[] @relation("MessageSender")
  messagesReceived        Message[] @relation("MessageRecipient")
  
  pushTokens              PushToken[]
  
  managerPermission       ManagerPermission?
  managedLocations        ManagerLocationAssignment[] @relation("ManagerLocations")
  managedWorkers          ManagerWorkerAssignment[]   @relation("ManagedWorkers")
  workerManagedBy         ManagerWorkerAssignment[]   @relation("WorkerManagers")
  
  leaveBalances           LeaveBalance[]
  timesheets              Timesheet[]
  timesheetsReviewed      Timesheet[] @relation("TimesheetReviewer")

  volunteerGoal           VolunteerGoal?
  volunteerSignOffRequests VolunteerSignOffRequest[]
  volunteerCertificates   VolunteerCertificate[]

  @@unique([companyId, phone])
  @@index([companyId, email])
  @@map("users")
}

model ManagerPermission {
  id                    String   @id @default(uuid())
  userId                String   @unique
  companyId             String
  
  canApproveTime        Boolean  @default(true)
  canEditTimePre        Boolean  @default(true)
  canEditTimePost       Boolean  @default(false)
  canDeleteTime         Boolean  @default(false)
  
  canViewLaborCosts     Boolean  @default(false)
  canViewAllLocations   Boolean  @default(false)
  canViewAllWorkers     Boolean  @default(false)
  
  canExportPayroll      Boolean  @default(false)
  canViewAnalytics      Boolean  @default(false)
  canGenerateReports    Boolean  @default(true)
  
  canOnboardWorkers     Boolean  @default(false)
  canDeactivateWorkers  Boolean  @default(false)
  canEditWorkerRates    Boolean  @default(false)
  
  canCreateShifts       Boolean  @default(true)
  canEditShifts         Boolean  @default(true)
  canDeleteShifts       Boolean  @default(false)
  canApproveShiftSwaps  Boolean  @default(true)
  canApproveTimeOff     Boolean  @default(true)
  
  canReviewViolations   Boolean  @default(true)
  canWaiveViolations    Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("manager_permissions")
}

model ManagerLocationAssignment {
  id          String   @id @default(uuid())
  managerId   String
  locationId  String
  companyId   String
  assignedAt  DateTime @default(now())
  assignedBy  String?

  manager     User     @relation("ManagerLocations", fields: [managerId], references: [id], onDelete: Cascade)
  location    Job      @relation("LocationManagers", fields: [locationId], references: [id], onDelete: Cascade)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([managerId, locationId])
  @@index([companyId])
  @@index([locationId])
  @@map("manager_location_assignments")
}

model ManagerWorkerAssignment {
  id          String   @id @default(uuid())
  managerId   String
  workerId    String
  companyId   String
  assignedAt  DateTime @default(now())
  assignedBy  String?

  manager     User     @relation("ManagedWorkers", fields: [managerId], references: [id], onDelete: Cascade)
  worker      User     @relation("WorkerManagers", fields: [workerId], references: [id], onDelete: Cascade)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([managerId, workerId])
  @@index([companyId])
  @@index([workerId])
  @@map("manager_worker_assignments")
}

enum PayPeriodStatus {
  OPEN
  LOCKED
  EXPORTED
}

model PayPeriod {
  id            String          @id @default(uuid())
  companyId     String
  startDate     DateTime        @db.Date
  endDate       DateTime        @db.Date
  status        PayPeriodStatus @default(OPEN)
  isAutoGenerated Boolean       @default(false)
  
  lockedAt      DateTime?
  lockedById    String?
  exportedAt    DateTime?
  exportedById  String?
  
  overrideAt    DateTime?
  overrideById  String?
  overrideReason String?
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  company       Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries   TimeEntry[]

  @@unique([companyId, startDate, endDate])
  @@index([companyId, status])
  @@index([companyId, startDate])
  @@map("pay_periods")
}

model WorkerJobRate {
  id              String   @id @default(uuid())
  companyId       String
  userId          String
  jobId           String
  hourlyRate      Decimal  @db.Decimal(10, 2)
  isPrevailingWage Boolean @default(false)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  job             Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([companyId])
  @@map("worker_job_rates")
}

model PasswordResetToken {
  id          String    @id @default(uuid())
  userId      String
  token       String    @unique
  expiresAt   DateTime
  used        Boolean   @default(false)
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, used, expiresAt])
  @@map("password_reset_tokens")
}

model Job {
  id                    String    @id @default(uuid())
  companyId             String
  name                  String
  address               String
  geofenceCenter        String
  geofenceRadiusMeters  Int       @default(100)
  isActive              Boolean   @default(true)
  defaultHourlyRate     Decimal?  @db.Decimal(10, 2)
  isPrevailingWage      Boolean   @default(false)
  
  projectNumber         String?
  contractNumber        String?
  wageDecisionNumber    String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  company               Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries           TimeEntry[]
  shifts                Shift[]
  shiftTemplates        ShiftTemplate[] @relation("ShiftTemplateJob")
  workerJobRates        WorkerJobRate[]
  certifiedPayrolls     CertifiedPayroll[]
  managers              ManagerLocationAssignment[] @relation("LocationManagers")

  @@index([companyId, isActive])
  @@map("jobs")
}

enum EntryType {
  JOB_TIME
  TRAVEL_TIME
}

model TimeEntry {
  id                String   @id @default(uuid())
  companyId         String?
  userId            String
  jobId             String?
  clockInTime       DateTime
  clockOutTime      DateTime?
  clockInPhotoUrl   String?
  clockOutPhotoUrl  String?
  clockInLocation   String?
  clockOutLocation  String?
  durationMinutes   Int?
  isFlagged         Boolean  @default(false)
  flagReason        String?
  notes             String?
  amendedAfterExport  Boolean   @default(false)

  breakStartTime    DateTime?
  breakEndTime      DateTime?
  breakMinutes      Int       @default(0)
  isOnBreak         Boolean   @default(false)
  workerType        WorkerType?

  approvalStatus    ApprovalStatus @default(PENDING)
  approvedById      String?
  approvedAt        DateTime?
  rejectionReason   String?

  hourlyRate        Decimal?  @db.Decimal(10, 2)
  laborCost         Decimal?  @db.Decimal(10, 2)
  isPrevailingWage  Boolean   @default(false)

  regularMinutes    Int       @default(0)
  overtimeMinutes   Int       @default(0)
  doubleTimeMinutes Int       @default(0)

  regularPay        Decimal?  @db.Decimal(10, 2)
  overtimePay       Decimal?  @db.Decimal(10, 2)
  doubleTimePay     Decimal?  @db.Decimal(10, 2)

  mealBreaksTaken   Int       @default(0)
  restBreaksTaken   Int       @default(0)
  breakCompliant    Boolean   @default(true)
  breakPenaltyPay   Decimal?  @db.Decimal(10, 2)
  
  isLocked          Boolean   @default(false)
  lockedAt          DateTime?
  payPeriodId       String?
  timesheetId       String?
  
  lastEditedById    String?
  lastEditedAt      DateTime?
  editReason        String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company           Company?  @relation(fields: [companyId], references: [id])
  user              User      @relation(fields: [userId], references: [id])
  job               Job?      @relation(fields: [jobId], references: [id])
  approvedBy        User?     @relation("ApprovedTimeEntries", fields: [approvedById], references: [id])
  payPeriod         PayPeriod? @relation(fields: [payPeriodId], references: [id])
  timesheet         Timesheet? @relation(fields: [timesheetId], references: [id])
  violations        Violation[]
  faceVerificationLogs FaceVerificationLog[]
  breakViolations   BreakViolation[]

  @@index([companyId, approvalStatus])
  @@index([userId, clockInTime])
  @@index([companyId, isLocked])
  @@index([payPeriodId])
  @@index([timesheetId])
  @@map("time_entries")
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

model Timesheet {
  id                String           @id @default(uuid())
  companyId         String
  userId            String
  
  periodStart       DateTime
  periodEnd         DateTime
  
  totalMinutes      Int              @default(0)
  totalBreakMinutes Int              @default(0)
  
  status            TimesheetStatus  @default(DRAFT)
  submittedAt       DateTime?
  reviewedAt        DateTime?
  reviewedById      String?
  reviewNotes       String?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  company           Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewedBy        User?            @relation("TimesheetReviewer", fields: [reviewedById], references: [id])
  entries           TimeEntry[]
  
  @@index([companyId, userId])
  @@index([companyId, status])
  @@map("timesheets")
}

model CertifiedPayroll {
  id              String    @id @default(uuid())
  companyId       String
  jobId           String
  weekEndingDate  DateTime  @db.Date
  payrollNumber   Int
  reportData      Json
  pdfUrl          String?
  status          String    @default("DRAFT")
  submittedAt     DateTime?
  submittedBy     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([companyId, jobId, weekEndingDate])
  @@index([companyId, weekEndingDate])
  @@map("certified_payrolls")
}

enum BreakViolationType {
  MISSED_MEAL_BREAK
  SHORT_MEAL_BREAK
  LATE_MEAL_BREAK
  MISSED_REST_BREAK
  MISSED_SECOND_MEAL
}

model BreakViolation {
  id              String              @id @default(uuid())
  companyId       String
  userId          String
  timeEntryId     String
  violationType   BreakViolationType
  description     String
  requiredMinutes Int
  actualMinutes   Int
  penaltyHours    Decimal             @db.Decimal(4, 2)
  penaltyAmount   Decimal?            @db.Decimal(10, 2)
  waived          Boolean             @default(false)
  waivedBy        String?
  waivedAt        DateTime?
  waivedReason    String?
  createdAt       DateTime            @default(now())

  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  timeEntry       TimeEntry           @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([timeEntryId])
  @@map("break_violations")
}

enum ViolationType {
  OUTSIDE_GEOFENCE
  LOCATION_TELEPORT
  FACE_MISMATCH
  EARLY_CLOCK_IN
  LATE_CLOCK_OUT
  PHOTO_REUSE
  SUSPICIOUS_PATTERN
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
}

model Violation {
  id            String              @id @default(uuid())
  companyId     String
  timeEntryId   String
  userId        String
  violationType ViolationType
  severity      ViolationSeverity
  metadata      Json                @default("{}")
  reviewed      Boolean             @default(false)
  reviewedBy    String?
  reviewedAt    DateTime?
  createdAt     DateTime            @default(now())

  company       Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntry     TimeEntry           @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, reviewed])
  @@index([companyId, severity])
  @@index([userId, createdAt])
  @@map("violations")
}

model FaceVerificationLog {
  id                  String    @id @default(uuid())
  companyId           String
  userId              String
  timeEntryId         String?
  submittedPhotoUrl   String
  confidenceScore     Float
  matched             Boolean
  rekognitionResponse Json
  createdAt           DateTime  @default(now())

  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  timeEntry           TimeEntry? @relation(fields: [timeEntryId], references: [id], onDelete: SetNull)

  @@index([companyId, userId])
  @@index([timeEntryId])
  @@map("face_verification_logs")
}

model OtpCode {
  id          String    @id @default(uuid())
  phone       String
  code        String
  expiresAt   DateTime
  verified    Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([phone, verified, expiresAt])
  @@map("otp_codes")
}

enum ShiftStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  OPEN
}

model ShiftTemplate {
  id            String      @id @default(uuid())
  companyId     String
  name          String
  daysOfWeek    Int[]
  startTime     String
  endTime       String
  jobId         String?
  notes         String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  job           Job?        @relation("ShiftTemplateJob", fields: [jobId], references: [id])
  shifts        Shift[]

  @@index([companyId, isActive])
  @@map("shift_templates")
}

model Shift {
  id                  String      @id @default(uuid())
  companyId           String
  userId              String?
  jobId               String?
  shiftDate           DateTime    @db.Date
  startTime           DateTime
  endTime             DateTime
  status              ShiftStatus @default(SCHEDULED)
  isOpen              Boolean     @default(false)
  notes               String?
  templateId          String?
  assignmentBatchId   String?
  assignmentStatus    ShiftAssignmentStatus @default(PENDING)
  declineReason       String?
  respondedAt         DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  company             Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  job                 Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  template            ShiftTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  shiftRequests       ShiftRequest[]

  @@index([companyId, shiftDate])
  @@index([companyId, isOpen])
  @@index([userId, shiftDate])
  @@index([jobId, shiftDate])
  @@index([templateId])
  @@index([assignmentBatchId])
  @@map("shifts")
}

enum ShiftRequestType {
  DROP
  SWAP
  OFFER
}

enum ShiftRequestStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}

enum ShiftOfferStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model ShiftRequest {
  id              String             @id @default(uuid())
  companyId       String
  shiftId         String
  requesterId     String
  requestType     ShiftRequestType
  reason          String
  
  swapTargetId    String?
  swapShiftId     String?
  
  status          ShiftRequestStatus @default(PENDING)
  reviewedById    String?
  reviewedAt      DateTime?
  reviewerNotes   String?
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  company         Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shift           Shift              @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  requester       User               @relation("ShiftRequestRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  swapTarget      User?              @relation("ShiftRequestSwapTarget", fields: [swapTargetId], references: [id], onDelete: SetNull)
  reviewedBy      User?              @relation("ShiftRequestReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  shiftOffers     ShiftOffer[]

  @@index([companyId, status])
  @@index([requesterId, status])
  @@index([shiftId])
  @@map("shift_requests")
}

model ShiftOffer {
  id              String           @id @default(uuid())
  shiftRequestId  String
  offeredToId     String
  status          ShiftOfferStatus @default(PENDING)
  respondedAt     DateTime?
  createdAt       DateTime         @default(now())

  shiftRequest    ShiftRequest     @relation(fields: [shiftRequestId], references: [id], onDelete: Cascade)
  offeredTo       User             @relation("ShiftOffersReceived", fields: [offeredToId], references: [id], onDelete: Cascade)

  @@index([shiftRequestId])
  @@index([offeredToId, status])
  @@map("shift_offers")
}

enum TimeOffType {
  PTO
  SICK
  UNPAID
  BEREAVEMENT
  JURY_DUTY
  OTHER
}

enum TimeOffStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}

model TimeOffRequest {
  id              String         @id @default(uuid())
  companyId       String
  requesterId     String
  timeOffType     TimeOffType
  startDate       DateTime       @db.Date
  endDate         DateTime       @db.Date
  reason          String?
  
  status          TimeOffStatus  @default(PENDING)
  reviewedById    String?
  reviewedAt      DateTime?
  reviewerNotes   String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  company         Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  requester       User           @relation("TimeOffRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  reviewedBy      User?          @relation("TimeOffReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)

  @@index([companyId, status])
  @@index([requesterId, status])
  @@index([companyId, startDate, endDate])
  @@map("time_off_requests")
}

model Message {
  id            String    @id @default(uuid())
  companyId     String
  senderId      String
  recipientId   String?
  subject       String?
  body          String
  isRead        Boolean   @default(false)
  readAt        DateTime?
  
  shiftRequestId    String?
  timeOffRequestId  String?
  
  createdAt     DateTime  @default(now())

  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sender        User      @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient     User?     @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: SetNull)

  @@index([companyId, recipientId, isRead])
  @@index([senderId, createdAt])
  @@index([recipientId, createdAt])
  @@map("messages")
}

model PushToken {
  id          String   @id @default(uuid())
  userId      String
  token       String
  platform    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@index([userId, isActive])
  @@index([token])
  @@map("push_tokens")
}

enum LeaveType {
  SICK
  VACATION
  PTO
  BEREAVEMENT
  JURY_DUTY
  CUSTOM
}

model LeavePolicy {
  id              String    @id @default(uuid())
  companyId       String
  name            String
  type            LeaveType
  annualHours     Float
  accrualRate     Float?
  maxCarryover    Float?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  balances        LeaveBalance[]

  @@index([companyId])
  @@map("leave_policies")
}

model LeaveBalance {
  id              String      @id @default(uuid())
  companyId       String
  userId          String
  policyId        String
  totalHours      Float       @default(0)
  usedHours       Float       @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  company         Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  policy          LeavePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([userId, policyId])
  @@index([companyId])
  @@index([userId])
  @@map("leave_balances")
}

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_APPROVED
  USER_REJECTED
  USER_DEACTIVATED
  USER_PHONE_CHANGED
  USER_ROLE_CHANGED
  JOB_CREATED
  JOB_UPDATED
  JOB_DELETED
  SHIFT_CREATED
  SHIFT_UPDATED
  SHIFT_DELETED
  SHIFT_CLAIMED
  COMPANY_SETTINGS_UPDATED
  LOGIN
  PASSWORD_RESET
  TIME_ENTRY_APPROVED
  TIME_ENTRY_REJECTED
  TIME_ENTRY_EDITED
  TIME_ENTRY_DELETED
  PAY_RATE_UPDATED
  OVERTIME_SETTINGS_UPDATED
  BREAK_VIOLATION_WAIVED
  CERTIFIED_PAYROLL_GENERATED
  CERTIFIED_PAYROLL_SUBMITTED
  SHIFT_REQUEST_CREATED
  SHIFT_REQUEST_APPROVED
  SHIFT_REQUEST_DECLINED
  SHIFT_REQUEST_CANCELLED
  TIME_OFF_REQUEST_CREATED
  TIME_OFF_REQUEST_APPROVED
  TIME_OFF_REQUEST_DECLINED
  TIME_OFF_REQUEST_CANCELLED
  MESSAGE_SENT
  MANAGER_PERMISSION_UPDATED
  MANAGER_LOCATION_ASSIGNED
  MANAGER_LOCATION_UNASSIGNED
  MANAGER_WORKER_ASSIGNED
  MANAGER_WORKER_UNASSIGNED
  PAY_PERIOD_CREATED
  PAY_PERIOD_LOCKED
  PAY_PERIOD_UNLOCKED
  PAY_PERIOD_EXPORTED
  LEAVE_POLICY_CREATED
  LEAVE_POLICY_UPDATED
  LEAVE_POLICY_DELETED
  LEAVE_BALANCE_UPDATED
  LEAVE_BALANCE_APPLIED_TO_ALL
}

model AuditLog {
  id          String      @id @default(uuid())
  companyId   String
  userId      String?
  action      AuditAction
  targetType  String?
  targetId    String?
  details     Json        @default("{}")
  ipAddress   String?
  createdAt   DateTime    @default(now())

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([companyId, action])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

model VolunteerGoal {
  id              String   @id @default(uuid())
  userId          String   @unique
  companyId       String
  targetHours     Int
  periodType      String   @default("MONTHLY")
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("volunteer_goals")
}

model VolunteerSignOffRequest {
  id              String   @id @default(uuid())
  userId          String
  companyId       String
  timeEntryIds    String[]
  totalMinutes    Int
  status          ApprovalStatus @default(PENDING)
  supervisorEmail String?
  supervisorName  String?
  notes           String?
  reviewedAt      DateTime?
  reviewedById    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([companyId])
  @@map("volunteer_sign_off_requests")
}

model VolunteerCertificate {
  id              String   @id @default(uuid())
  userId          String
  companyId       String
  title           String
  description     String?
  hoursEarned     Int
  issuedAt        DateTime @default(now())
  pdfUrl          String?

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@map("volunteer_certificates")
}
