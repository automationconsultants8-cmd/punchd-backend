// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                    String   @id @default(uuid())
  name                  String
  address               String?
  city                  String?
  state                 String?
  zip                   String?
  inviteCode            String   @unique @default(uuid())
  defaultHourlyRate     Decimal? @db.Decimal(10, 2)
  subscriptionTier      String   @default("basic")
  subscriptionStatus    String   @default("active")
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  trialEndsAt           DateTime?
  settings              Json     @default("{}")
  overtimeSettings      Json     @default("{\"dailyOtThreshold\": 480, \"dailyDtThreshold\": 720, \"weeklyOtThreshold\": 2400, \"otMultiplier\": 1.5, \"dtMultiplier\": 2.0}")
  breakComplianceSettings Json   @default("{\"enabled\": true, \"state\": \"CA\", \"mealBreakThreshold\": 300, \"mealBreakDuration\": 30, \"secondMealThreshold\": 600, \"restBreakInterval\": 240, \"restBreakDuration\": 10, \"penaltyRate\": 1.0}")
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  users                 User[]
  jobs                  Job[]
  timeEntries           TimeEntry[]
  violations            Violation[]
  faceVerificationLogs  FaceVerificationLog[]
  shifts                Shift[]
  auditLogs             AuditLog[]
  workerJobRates        WorkerJobRate[]
  breakViolations       BreakViolation[]
  certifiedPayrolls     CertifiedPayroll[]
  shiftRequests         ShiftRequest[]
  timeOffRequests       TimeOffRequest[]
  messages              Message[]

  @@map("companies")
}


enum UserRole {
  WORKER
  MANAGER
  ADMIN
  OWNER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id                  String         @id @default(uuid())
  companyId           String
  email               String?
  phone               String
  name                String
  role                UserRole       @default(WORKER)
  referencePhotoUrl   String?
  rekognitionFaceId   String?
  isActive            Boolean        @default(true)
  approvalStatus      ApprovalStatus @default(APPROVED)
  passwordHash        String?
  hourlyRate          Decimal?       @db.Decimal(10, 2)
  
  address             String?
  city                String?
  state               String?
  zip                 String?
  lastFourSSN         String?
  tradeClassification String?
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries         TimeEntry[]
  violations          Violation[]
  faceVerificationLogs FaceVerificationLog[]
  shifts              Shift[]
  passwordResetTokens PasswordResetToken[]
  approvedTimeEntries TimeEntry[] @relation("ApprovedTimeEntries")
  jobRates            WorkerJobRate[]
  breakViolations     BreakViolation[]
  
  shiftRequestsCreated    ShiftRequest[] @relation("ShiftRequestRequester")
  shiftRequestsAsTarget   ShiftRequest[] @relation("ShiftRequestSwapTarget")
  shiftRequestsReviewed   ShiftRequest[] @relation("ShiftRequestReviewer")
  shiftOffersReceived     ShiftOffer[]   @relation("ShiftOffersReceived")
  
  timeOffRequestsCreated  TimeOffRequest[] @relation("TimeOffRequester")
  timeOffRequestsReviewed TimeOffRequest[] @relation("TimeOffReviewer")
  
  messagesSent            Message[] @relation("MessageSender")
  messagesReceived        Message[] @relation("MessageRecipient")
  
  pushTokens              PushToken[]

  @@unique([companyId, phone])
  @@index([companyId, email])
  @@map("users")
}

model WorkerJobRate {
  id              String   @id @default(uuid())
  companyId       String
  userId          String
  jobId           String
  hourlyRate      Decimal  @db.Decimal(10, 2)
  isPrevailingWage Boolean @default(false)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  job             Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([companyId])
  @@map("worker_job_rates")
}

model PasswordResetToken {
  id          String    @id @default(uuid())
  userId      String
  token       String    @unique
  expiresAt   DateTime
  used        Boolean   @default(false)
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, used, expiresAt])
  @@map("password_reset_tokens")
}

model Job {
  id                    String    @id @default(uuid())
  companyId             String
  name                  String
  address               String
  geofenceCenter        String
  geofenceRadiusMeters  Int       @default(100)
  isActive              Boolean   @default(true)
  defaultHourlyRate     Decimal?  @db.Decimal(10, 2)
  isPrevailingWage      Boolean   @default(false)
  
  projectNumber         String?
  contractNumber        String?
  wageDecisionNumber    String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  company               Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries           TimeEntry[]
  shifts                Shift[]
  workerJobRates        WorkerJobRate[]
  certifiedPayrolls     CertifiedPayroll[]

  @@index([companyId, isActive])
  @@map("jobs")
}

enum EntryType {
  JOB_TIME
  TRAVEL_TIME
}

model TimeEntry {
  id                String   @id @default(uuid())
  companyId         String?
  userId            String
  jobId             String?
  clockInTime       DateTime
  clockOutTime      DateTime?
  clockInPhotoUrl   String?
  clockOutPhotoUrl  String?
  clockInLocation   String?
  clockOutLocation  String?
  durationMinutes   Int?
  isFlagged         Boolean  @default(false)
  flagReason        String?
  notes             String?

  breakStartTime    DateTime?
  breakEndTime      DateTime?
  breakMinutes      Int       @default(0)
  isOnBreak         Boolean   @default(false)

  approvalStatus    ApprovalStatus @default(PENDING)
  approvedById      String?
  approvedAt        DateTime?
  rejectionReason   String?

  hourlyRate        Decimal?  @db.Decimal(10, 2)
  laborCost         Decimal?  @db.Decimal(10, 2)
  isPrevailingWage  Boolean   @default(false)

  regularMinutes    Int       @default(0)
  overtimeMinutes   Int       @default(0)
  doubleTimeMinutes Int       @default(0)

  regularPay        Decimal?  @db.Decimal(10, 2)
  overtimePay       Decimal?  @db.Decimal(10, 2)
  doubleTimePay     Decimal?  @db.Decimal(10, 2)

  mealBreaksTaken   Int       @default(0)
  restBreaksTaken   Int       @default(0)
  breakCompliant    Boolean   @default(true)
  breakPenaltyPay   Decimal?  @db.Decimal(10, 2)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company           Company?  @relation(fields: [companyId], references: [id])
  user              User      @relation(fields: [userId], references: [id])
  job               Job?      @relation(fields: [jobId], references: [id])
  approvedBy        User?     @relation("ApprovedTimeEntries", fields: [approvedById], references: [id])
  violations        Violation[]
  faceVerificationLogs FaceVerificationLog[]
  breakViolations   BreakViolation[]

  @@index([companyId, approvalStatus])
  @@index([userId, clockInTime])
  @@map("time_entries")
}

model CertifiedPayroll {
  id              String    @id @default(uuid())
  companyId       String
  jobId           String
  weekEndingDate  DateTime  @db.Date
  payrollNumber   Int
  reportData      Json
  pdfUrl          String?
  status          String    @default("DRAFT")
  submittedAt     DateTime?
  submittedBy     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([companyId, jobId, weekEndingDate])
  @@index([companyId, weekEndingDate])
  @@map("certified_payrolls")
}

enum BreakViolationType {
  MISSED_MEAL_BREAK
  SHORT_MEAL_BREAK
  LATE_MEAL_BREAK
  MISSED_REST_BREAK
  MISSED_SECOND_MEAL
}

model BreakViolation {
  id              String              @id @default(uuid())
  companyId       String
  userId          String
  timeEntryId     String
  violationType   BreakViolationType
  description     String
  requiredMinutes Int
  actualMinutes   Int
  penaltyHours    Decimal             @db.Decimal(4, 2)
  penaltyAmount   Decimal?            @db.Decimal(10, 2)
  waived          Boolean             @default(false)
  waivedBy        String?
  waivedAt        DateTime?
  waivedReason    String?
  createdAt       DateTime            @default(now())

  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  timeEntry       TimeEntry           @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([timeEntryId])
  @@map("break_violations")
}

enum ViolationType {
  OUTSIDE_GEOFENCE
  LOCATION_TELEPORT
  FACE_MISMATCH
  EARLY_CLOCK_IN
  LATE_CLOCK_OUT
  PHOTO_REUSE
  SUSPICIOUS_PATTERN
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
}

model Violation {
  id            String              @id @default(uuid())
  companyId     String
  timeEntryId   String
  userId        String
  violationType ViolationType
  severity      ViolationSeverity
  metadata      Json                @default("{}")
  reviewed      Boolean             @default(false)
  reviewedBy    String?
  reviewedAt    DateTime?
  createdAt     DateTime            @default(now())

  company       Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntry     TimeEntry           @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, reviewed])
  @@index([companyId, severity])
  @@index([userId, createdAt])
  @@map("violations")
}

model FaceVerificationLog {
  id                  String    @id @default(uuid())
  companyId           String
  userId              String
  timeEntryId         String?
  submittedPhotoUrl   String
  confidenceScore     Float
  matched             Boolean
  rekognitionResponse Json
  createdAt           DateTime  @default(now())

  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  timeEntry           TimeEntry? @relation(fields: [timeEntryId], references: [id], onDelete: SetNull)

  @@index([companyId, userId])
  @@index([timeEntryId])
  @@map("face_verification_logs")
}

model OtpCode {
  id          String    @id @default(uuid())
  phone       String
  code        String
  expiresAt   DateTime
  verified    Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([phone, verified, expiresAt])
  @@map("otp_codes")
}

enum ShiftStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  OPEN
}

model Shift {
  id            String      @id @default(uuid())
  companyId     String
  userId        String?
  jobId         String
  shiftDate     DateTime    @db.Date
  startTime     DateTime
  endTime       DateTime
  status        ShiftStatus @default(SCHEDULED)
  isOpen        Boolean     @default(false)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user          User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  job           Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  shiftRequests ShiftRequest[]

  @@index([companyId, shiftDate])
  @@index([companyId, isOpen])
  @@index([userId, shiftDate])
  @@index([jobId, shiftDate])
  @@map("shifts")
}

enum ShiftRequestType {
  DROP
  SWAP
  OFFER
}

enum ShiftRequestStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}

enum ShiftOfferStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model ShiftRequest {
  id              String             @id @default(uuid())
  companyId       String
  shiftId         String
  requesterId     String
  requestType     ShiftRequestType
  reason          String
  
  swapTargetId    String?
  swapShiftId     String?
  
  status          ShiftRequestStatus @default(PENDING)
  reviewedById    String?
  reviewedAt      DateTime?
  reviewerNotes   String?
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  company         Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shift           Shift              @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  requester       User               @relation("ShiftRequestRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  swapTarget      User?              @relation("ShiftRequestSwapTarget", fields: [swapTargetId], references: [id], onDelete: SetNull)
  reviewedBy      User?              @relation("ShiftRequestReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  shiftOffers     ShiftOffer[]

  @@index([companyId, status])
  @@index([requesterId, status])
  @@index([shiftId])
  @@map("shift_requests")
}

model ShiftOffer {
  id              String           @id @default(uuid())
  shiftRequestId  String
  offeredToId     String
  status          ShiftOfferStatus @default(PENDING)
  respondedAt     DateTime?
  createdAt       DateTime         @default(now())

  shiftRequest    ShiftRequest     @relation(fields: [shiftRequestId], references: [id], onDelete: Cascade)
  offeredTo       User             @relation("ShiftOffersReceived", fields: [offeredToId], references: [id], onDelete: Cascade)

  @@index([shiftRequestId])
  @@index([offeredToId, status])
  @@map("shift_offers")
}

enum TimeOffType {
  PTO
  SICK
  UNPAID
  BEREAVEMENT
  JURY_DUTY
  OTHER
}

enum TimeOffStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}

model TimeOffRequest {
  id              String         @id @default(uuid())
  companyId       String
  requesterId     String
  timeOffType     TimeOffType
  startDate       DateTime       @db.Date
  endDate         DateTime       @db.Date
  reason          String?
  
  status          TimeOffStatus  @default(PENDING)
  reviewedById    String?
  reviewedAt      DateTime?
  reviewerNotes   String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  company         Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  requester       User           @relation("TimeOffRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  reviewedBy      User?          @relation("TimeOffReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)

  @@index([companyId, status])
  @@index([requesterId, status])
  @@index([companyId, startDate, endDate])
  @@map("time_off_requests")
}

model Message {
  id            String    @id @default(uuid())
  companyId     String
  senderId      String
  recipientId   String?
  subject       String?
  body          String
  isRead        Boolean   @default(false)
  readAt        DateTime?
  
  shiftRequestId    String?
  timeOffRequestId  String?
  
  createdAt     DateTime  @default(now())

  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sender        User      @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient     User?     @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: SetNull)

  @@index([companyId, recipientId, isRead])
  @@index([senderId, createdAt])
  @@index([recipientId, createdAt])
  @@map("messages")
}

model PushToken {
  id          String   @id @default(uuid())
  userId      String
  token       String
  platform    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@index([userId, isActive])
  @@index([token])
  @@map("push_tokens")
}

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_APPROVED
  USER_REJECTED
  USER_DEACTIVATED
  USER_PHONE_CHANGED
  USER_ROLE_CHANGED
  JOB_CREATED
  JOB_UPDATED
  JOB_DELETED
  SHIFT_CREATED
  SHIFT_UPDATED
  SHIFT_DELETED
  SHIFT_CLAIMED
  COMPANY_SETTINGS_UPDATED
  LOGIN
  PASSWORD_RESET
  TIME_ENTRY_APPROVED
  TIME_ENTRY_REJECTED
  PAY_RATE_UPDATED
  OVERTIME_SETTINGS_UPDATED
  BREAK_VIOLATION_WAIVED
  CERTIFIED_PAYROLL_GENERATED
  CERTIFIED_PAYROLL_SUBMITTED
  SHIFT_REQUEST_CREATED
  SHIFT_REQUEST_APPROVED
  SHIFT_REQUEST_DECLINED
  SHIFT_REQUEST_CANCELLED
  TIME_OFF_REQUEST_CREATED
  TIME_OFF_REQUEST_APPROVED
  TIME_OFF_REQUEST_DECLINED
  TIME_OFF_REQUEST_CANCELLED
  MESSAGE_SENT
}

model AuditLog {
  id          String      @id @default(uuid())
  companyId   String
  userId      String?
  action      AuditAction
  targetType  String?
  targetId    String?
  details     Json        @default("{}")
  ipAddress   String?
  createdAt   DateTime    @default(now())

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([companyId, action])
  @@index([userId, createdAt])
  @@map("audit_logs")
}
