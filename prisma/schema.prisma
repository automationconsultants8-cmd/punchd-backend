// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                    String   @id @default(uuid())
  name                  String
  inviteCode            String   @unique @default(uuid())
  subscriptionTier      String   @default("basic")
  subscriptionStatus    String   @default("active")
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  trialEndsAt           DateTime?
  settings              Json     @default("{}")
  overtimeSettings      Json     @default("{\"dailyOtThreshold\": 480, \"dailyDtThreshold\": 720, \"weeklyOtThreshold\": 2400, \"otMultiplier\": 1.5, \"dtMultiplier\": 2.0}")
  breakComplianceSettings Json   @default("{\"enabled\": true, \"state\": \"CA\", \"mealBreakThreshold\": 300, \"mealBreakDuration\": 30, \"secondMealThreshold\": 600, \"restBreakInterval\": 240, \"restBreakDuration\": 10, \"penaltyRate\": 1.0}")
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  users                 User[]
  jobs                  Job[]
  timeEntries           TimeEntry[]
  violations            Violation[]
  faceVerificationLogs  FaceVerificationLog[]
  shifts                Shift[]
  auditLogs             AuditLog[]
  workerJobRates        WorkerJobRate[]
  breakViolations       BreakViolation[]

  @@map("companies")
}

enum UserRole {
  WORKER
  MANAGER
  ADMIN
  OWNER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id                  String         @id @default(uuid())
  companyId           String
  email               String?
  phone               String
  name                String
  role                UserRole       @default(WORKER)
  referencePhotoUrl   String?
  rekognitionFaceId   String?
  isActive            Boolean        @default(true)
  approvalStatus      ApprovalStatus @default(APPROVED)
  passwordHash        String?
  hourlyRate          Decimal?       @db.Decimal(10, 2)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries         TimeEntry[]
  violations          Violation[]
  faceVerificationLogs FaceVerificationLog[]
  shifts              Shift[]
  passwordResetTokens PasswordResetToken[]
  approvedTimeEntries TimeEntry[] @relation("ApprovedTimeEntries")
  jobRates            WorkerJobRate[]
  breakViolations     BreakViolation[]

  @@unique([companyId, phone])
  @@index([companyId, email])
  @@map("users")
}

model WorkerJobRate {
  id              String   @id @default(uuid())
  companyId       String
  userId          String
  jobId           String
  hourlyRate      Decimal  @db.Decimal(10, 2)
  isPrevailingWage Boolean @default(false)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  job             Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([companyId])
  @@map("worker_job_rates")
}

model PasswordResetToken {
  id          String    @id @default(uuid())
  userId      String
  token       String    @unique
  expiresAt   DateTime
  used        Boolean   @default(false)
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, used, expiresAt])
  @@map("password_reset_tokens")
}

model Job {
  id                    String    @id @default(uuid())
  companyId             String
  name                  String
  address               String
  geofenceCenter        String
  geofenceRadiusMeters  Int       @default(100)
  isActive              Boolean   @default(true)
  defaultHourlyRate     Decimal?  @db.Decimal(10, 2)
  isPrevailingWage      Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  company               Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries           TimeEntry[]
  shifts                Shift[]
  workerJobRates        WorkerJobRate[]

  @@index([companyId, isActive])
  @@map("jobs")
}

enum EntryType {
  JOB_TIME
  TRAVEL_TIME
}

model TimeEntry {
  id                String   @id @default(uuid())
  companyId         String?
  userId            String
  jobId             String?
  clockInTime       DateTime
  clockOutTime      DateTime?
  clockInPhotoUrl   String?
  clockOutPhotoUrl  String?
  clockInLocation   String?
  clockOutLocation  String?
  durationMinutes   Int?
  isFlagged         Boolean  @default(false)
  flagReason        String?
  notes             String?

  breakStartTime    DateTime?
  breakEndTime      DateTime?
  breakMinutes      Int       @default(0)
  isOnBreak         Boolean   @default(false)

  // Approval workflow fields
  approvalStatus    ApprovalStatus @default(PENDING)
  approvedById      String?
  approvedAt        DateTime?
  rejectionReason   String?

  // Pay rate fields (snapshot at time of entry)
  hourlyRate        Decimal?  @db.Decimal(10, 2)
  laborCost         Decimal?  @db.Decimal(10, 2)
  isPrevailingWage  Boolean   @default(false)

  // Overtime breakdown (in minutes)
  regularMinutes    Int       @default(0)
  overtimeMinutes   Int       @default(0)
  doubleTimeMinutes Int       @default(0)

  // Pay breakdown
  regularPay        Decimal?  @db.Decimal(10, 2)
  overtimePay       Decimal?  @db.Decimal(10, 2)
  doubleTimePay     Decimal?  @db.Decimal(10, 2)

  // Break compliance
  mealBreaksTaken   Int       @default(0)
  restBreaksTaken   Int       @default(0)
  breakCompliant    Boolean   @default(true)
  breakPenaltyPay   Decimal?  @db.Decimal(10, 2)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company           Company?  @relation(fields: [companyId], references: [id])
  user              User      @relation(fields: [userId], references: [id])
  job               Job?      @relation(fields: [jobId], references: [id])
  approvedBy        User?     @relation("ApprovedTimeEntries", fields: [approvedById], references: [id])
  violations        Violation[]
  faceVerificationLogs FaceVerificationLog[]
  breakViolations   BreakViolation[]

  @@index([companyId, approvalStatus])
  @@index([userId, clockInTime])
  @@map("time_entries")
}

enum BreakViolationType {
  MISSED_MEAL_BREAK
  SHORT_MEAL_BREAK
  LATE_MEAL_BREAK
  MISSED_REST_BREAK
  MISSED_SECOND_MEAL
}

model BreakViolation {
  id              String              @id @default(uuid())
  companyId       String
  userId          String
  timeEntryId     String
  violationType   BreakViolationType
  description     String
  requiredMinutes Int
  actualMinutes   Int
  penaltyHours    Decimal             @db.Decimal(4, 2)
  penaltyAmount   Decimal?            @db.Decimal(10, 2)
  waived          Boolean             @default(false)
  waivedBy        String?
  waivedAt        DateTime?
  waivedReason    String?
  createdAt       DateTime            @default(now())

  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  timeEntry       TimeEntry           @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([timeEntryId])
  @@map("break_violations")
}

enum ViolationType {
  OUTSIDE_GEOFENCE
  LOCATION_TELEPORT
  FACE_MISMATCH
  EARLY_CLOCK_IN
  LATE_CLOCK_OUT
  PHOTO_REUSE
  SUSPICIOUS_PATTERN
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
}

model Violation {
  id            String              @id @default(uuid())
  companyId     String
  timeEntryId   String
  userId        String
  violationType ViolationType
  severity      ViolationSeverity
  metadata      Json                @default("{}")
  reviewed      Boolean             @default(false)
  reviewedBy    String?
  reviewedAt    DateTime?
  createdAt     DateTime            @default(now())

  company       Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntry     TimeEntry           @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, reviewed])
  @@index([companyId, severity])
  @@index([userId, createdAt])
  @@map("violations")
}

model FaceVerificationLog {
  id                  String    @id @default(uuid())
  companyId           String
  userId              String
  timeEntryId         String?
  submittedPhotoUrl   String
  confidenceScore     Float
  matched             Boolean
  rekognitionResponse Json
  createdAt           DateTime  @default(now())

  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  timeEntry           TimeEntry? @relation(fields: [timeEntryId], references: [id], onDelete: SetNull)

  @@index([companyId, userId])
  @@index([timeEntryId])
  @@map("face_verification_logs")
}

model OtpCode {
  id          String    @id @default(uuid())
  phone       String
  code        String
  expiresAt   DateTime
  verified    Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([phone, verified, expiresAt])
  @@map("otp_codes")
}

enum ShiftStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Shift {
  id            String      @id @default(uuid())
  companyId     String
  userId        String
  jobId         String
  shiftDate     DateTime    @db.Date
  startTime     DateTime
  endTime       DateTime
  status        ShiftStatus @default(SCHEDULED)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  job           Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([companyId, shiftDate])
  @@index([userId, shiftDate])
  @@index([jobId, shiftDate])
  @@map("shifts")
}

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_APPROVED
  USER_REJECTED
  USER_DEACTIVATED
  USER_PHONE_CHANGED
  USER_ROLE_CHANGED
  JOB_CREATED
  JOB_UPDATED
  JOB_DELETED
  SHIFT_CREATED
  SHIFT_UPDATED
  SHIFT_DELETED
  COMPANY_SETTINGS_UPDATED
  LOGIN
  PASSWORD_RESET
  TIME_ENTRY_APPROVED
  TIME_ENTRY_REJECTED
  PAY_RATE_UPDATED
  OVERTIME_SETTINGS_UPDATED
  BREAK_VIOLATION_WAIVED
}

model AuditLog {
  id          String      @id @default(uuid())
  companyId   String
  userId      String?
  action      AuditAction
  targetType  String?
  targetId    String?
  details     Json        @default("{}")
  ipAddress   String?
  createdAt   DateTime    @default(now())

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([companyId, action])
  @@index([userId, createdAt])
  @@map("audit_logs")
}
